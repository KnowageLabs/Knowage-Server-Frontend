<template>
    <div ref="document" class="kn-height-full detail-page-container">
        <Toolbar v-if="showToolbar" class="kn-toolbar kn-toolbar--primary p-col-12">
            <template #start>
                <DocumentExecutionBreadcrumb v-if="breadcrumbs.length > 1" :breadcrumbs="breadcrumbs" @breadcrumbClicked="onBreadcrumbClick"></DocumentExecutionBreadcrumb>
                <span v-else>{{ crossNavigationSourceDocumentName ? crossNavigationSourceDocumentName : document?.name }}</span>
            </template>
            <template #end>
                <div class="p-d-flex p-jc-around">
                    <Button
                        v-if="mode == 'dashboard' && canSeeDashboardFunctions() && propMode !== 'document-execution-cross-navigation-popup'"
                        v-tooltip.left="$t('common.datasets')"
                        icon="fas fa-database"
                        class="p-button-text p-button-rounded p-button-plain p-mx-2"
                        :class="{ 'dashboard-toolbar-icon': mode === 'dashboard' }"
                        @click="openDashboardDatasetManagement"
                    ></Button>
                    <Button
                        v-if="mode == 'dashboard' && canSeeDashboardFunctions() && propMode !== 'document-execution-cross-navigation-popup'"
                        v-tooltip.left="$t('common.save')"
                        icon="pi pi-save"
                        class="p-button-text p-button-rounded p-button-plain p-mx-2"
                        :class="{ 'dashboard-toolbar-icon': mode === 'dashboard' }"
                        @click="saveDashboard"
                    ></Button>
                    <Button v-if="mode !== 'dashboard' && canEditCockpit && documentMode === 'VIEW'" v-tooltip.left="$t('documentExecution.main.editCockpit')" icon="pi pi-pencil" class="p-button-text p-button-rounded p-button-plain p-mx-2" @click="editCockpitDocumentConfirm"></Button>
                    <Button v-if="mode !== 'dashboard' && canEditCockpit && documentMode === 'EDIT'" v-tooltip.left="$t('documentExecution.main.viewCockpit')" icon="fa fa-eye" class="p-button-text p-button-rounded p-button-plain p-mx-2" @click="editCockpitDocumentConfirm"></Button>
                    <Button
                        v-if="!newDashboardMode && propMode !== 'document-execution-cross-navigation-popup'"
                        v-tooltip.left="$t('common.refresh')"
                        icon="pi pi-refresh"
                        class="p-button-text p-button-rounded p-button-plain p-mx-2"
                        :class="{ 'dashboard-toolbar-icon': mode === 'dashboard' }"
                        @click="refresh"
                    ></Button>
                    <Button
                        v-if="isParameterSidebarVisible && !newDashboardMode && !$route.query.hideParameters"
                        v-tooltip.left="$t('common.parameters')"
                        icon="fa fa-filter"
                        class="p-button-text p-button-rounded p-button-plain p-mx-2"
                        :class="{ 'dashboard-toolbar-icon': mode === 'dashboard' }"
                        data-test="parameter-sidebar-icon"
                        @click="parameterSidebarVisible = !parameterSidebarVisible"
                    ></Button>
                    <Button v-if="propMode !== 'document-execution-cross-navigation-popup'" v-tooltip.left="$t('common.menu')" icon="fa fa-ellipsis-v" class="p-button-text p-button-rounded p-button-plain p-mx-2" :class="{ 'dashboard-toolbar-icon': mode === 'dashboard' }" @click="toggle"></Button>
                    <TieredMenu ref="menu" :model="toolbarMenuItems" :popup="true" />
                    <Button v-if="mode == 'dashboard' && canSeeDashboardFunctions() && propMode != 'document-execution-cross-navigation-popup'" id="add-widget-button" class="p-button-sm" :label="$t('dashboard.widgetEditor.addWidget')" icon="pi pi-plus-circle" @click="addWidget" />
                    <Button v-if="isInDocBrowser" v-tooltip.left="$t('common.close')" icon="fa fa-times" class="p-button-text p-button-rounded p-button-plain p-mx-2" :class="{ 'dashboard-toolbar-icon': mode === 'dashboard' }" @click="closeDocumentConfirm"></Button>
                </div>
            </template>
        </Toolbar>
        <ProgressBar v-if="loading || loadingCrossNavigationDocument" class="kn-progress-bar" mode="indeterminate" />
        <div ref="document-execution-view" class="p-d-flex p-flex-row document-execution-view myDivToPrint">
            <Button id="scheduledExcelExportButton" class="hidden-button" @click="hiddenExport('XLSX')"></Button>
            <div v-if="parameterSidebarVisible" :class="propMode === 'document-execution-cross-navigation-popup' ? 'document-execution-backdrop-popup-dialog' : 'document-execution-backdrop'" @click="parameterSidebarVisible = false"></div>
            <div v-show="downloadMode" class="downloadingBox">{{ $t('dashboard.warning.downloading') }}</div>
            <div v-show="!downloadMode && (showExecutedDocument || newDashboardMode)" class="kn-flex">
                <Registry v-if="showExecutedDocument && mode === 'registry'" :id="urlData?.sbiExecutionId" :reload-trigger="reloadTrigger"></Registry>
                <Dossier v-else-if="showExecutedDocument && mode === 'dossier'" :id="document.id" :reload-trigger="reloadTrigger" :filter-data="filtersData" :user-role="userRole"></Dossier>
                <Olap
                    v-else-if="showExecutedDocument && mode === 'olap'"
                    :id="urlData?.sbiExecutionId"
                    :olap-id="document.id"
                    :olap-name="document.label"
                    :reload-trigger="reloadTrigger"
                    :olap-custom-view-visible="olapCustomViewVisible"
                    :hidden-form-data-prop="hiddenFormData"
                    @closeOlapCustomView="olapCustomViewVisible = false"
                    @applyCustomView="executeOlapCustomView"
                    @executeCrossNavigation="executeOLAPCrossNavigation"
                ></Olap>
                <DashboardController
                    v-else-if="showExecutedDocument && propMode === 'document-execution-cross-navigation-popup' && document"
                    :visible="filtersData && filtersData.isReadyForExecution && !loading"
                    :document="document"
                    :reload-trigger="reloadTrigger"
                    :mode="'dashboard-popup'"
                    :filters-data="filtersData"
                    :new-dashboard-mode="false"
                ></DashboardController>
                <div v-show="mode === 'dashboard' || newDashboardMode" class="p-d-flex p-flex-row" style="height: 100%">
                    <template v-for="(item, index) in breadcrumbs" :key="index">
                        <DashboardController
                            :visible="((filtersData && filtersData.isReadyForExecution) || newDashboardMode) && !loading && !schedulationsTableVisible && (item.label === document.name || newDashboardMode || (crossNavigationDialogVisible && index === breadcrumbs.length - 1))"
                            :document="item.document"
                            :reload-trigger="reloadTrigger"
                            :hidden-form-data="item.hiddenFormData"
                            :filters-data="item.filtersData"
                            :new-dashboard-mode="newDashboardMode"
                            :mode="mode"
                            :prop-view="dashboardView"
                            @executeView="executeView"
                            @dashboardIdSet="onSetDashboardId($event, item)"
                            @newDashboardSaved="onNewDashboardSaved"
                            @executeCrossNavigation="onExecuteCrossNavigation"
                        ></DashboardController>
                    </template>
                </div>
            </div>
            <iframe
                v-for="(item, index) in breadcrumbs"
                v-show="mode === 'iframe' && filtersData && filtersData.isReadyForExecution && !loading && !schedulationsTableVisible && (item.label === document.name || (crossNavigationContainerData && index === breadcrumbs.length - 1))"
                :key="index"
                ref="documentFrame"
                :name="'documentFrame' + index"
                class="document-execution-iframe"
            ></iframe>

            <DocumentExecutionSchedulationsTable v-if="schedulationsTableVisible" id="document-execution-schedulations-table" :prop-schedulations="schedulations" @deleteSchedulation="onDeleteSchedulation" @close="schedulationsTableVisible = false"></DocumentExecutionSchedulationsTable>

            <KnParameterSidebar
                v-show="parameterSidebarVisible"
                class="document-execution-parameter-sidebar kn-overflow-y"
                :filters-data="filtersData"
                :prop-document="document"
                :user-role="userRole"
                :session-enabled="sessionEnabled"
                :date-format="dateFormat"
                :show-in-dialog="true"
                data-test="parameter-sidebar"
                @execute="onExecute"
                @exportCSV="onExportCSV"
                @roleChanged="onRoleChange"
                @parametersChanged="$emit('parametersChanged', $event)"
            ></KnParameterSidebar>

            <DocumentExecutionHelpDialog :visible="helpDialogVisible" :prop-document="document" @close="helpDialogVisible = false"></DocumentExecutionHelpDialog>

            <DocumentExecutionRankDialog :visible="rankDialogVisible" :prop-document-rank="documentRank" @close="rankDialogVisible = false" @saveRank="onSaveRank"></DocumentExecutionRankDialog>
            <DocumentExecutionNotesDialog :visible="notesDialogVisible" :prop-document="document" @close="notesDialogVisible = false"></DocumentExecutionNotesDialog>
            <DocumentExecutionMetadataDialog :visible="metadataDialogVisible" :prop-document="document" :prop-metadata="metadata" :prop-loading="metadataLoading" @close="metadataDialogVisible = false" @saveMetadata="onMetadataSave"></DocumentExecutionMetadataDialog>
            <DocumentExecutionMailDialog :visible="mailDialogVisible" @close="mailDialogVisible = false" @sendMail="onMailSave"></DocumentExecutionMailDialog>
            <DocumentExecutionLinkDialog :visible="linkDialogVisible" :link-info="linkInfo" :embed-h-t-m-l="embedHTML" :prop-document="document" :prop-filters-data="filtersData" @close="linkDialogVisible = false"></DocumentExecutionLinkDialog>
            <DocumentExecutionSelectCrossNavigationDialog :visible="destinationSelectDialogVisible" :cross-navigation-documents="crossNavigationDocuments" @close="destinationSelectDialogVisible = false" @selected="onCrossNavigationSelected"></DocumentExecutionSelectCrossNavigationDialog>
            <DocumentExecutionCNContainerDialog v-if="angularData && crossNavigationContainerData" :visible="crossNavigationContainerVisible" :data="crossNavigationContainerData" @close="onCrossNavigationContainerClose"></DocumentExecutionCNContainerDialog>
            <WorkspaceFolderPickerDialog v-if="workspaceFolderPickerDialogVisible" :visible="workspaceFolderPickerDialogVisible" :document="document" @close="workspaceFolderPickerDialogVisible = false"></WorkspaceFolderPickerDialog>
            <Dialog class="p-fluid kn-dialog--toolbar--primary" :content-style="descriptor.popupDialog.style" :visible="crossNavigationDialogVisible" :modal="true" :show-header="false" :closable="false">
                <DocumentExecution
                    v-if="crossNavigationPopupDialogDocument"
                    :id="crossNavigationPopupDialogDocument?.label"
                    :prop-mode="'document-execution-cross-navigation-popup'"
                    :parameter-values-map="parameterValuesMap"
                    :tab-key="tabKey"
                    :prop-cross-navigation-popup-dialog-document="crossNavigationPopupDialogDocument"
                    @parametersChanged="$emit('parametersChanged', $event)"
                    @close="onCrossNavigationPopupClose()"
                ></DocumentExecution>
            </Dialog>

            <DashboardSaveViewDialog v-if="saveViewDialogVisible" :visible="saveViewDialogVisible" :prop-view="selectedCockpitView" :document="document" @close="onSaveViewDialogClose"></DashboardSaveViewDialog>
            <DashboardSavedViewsDialog v-if="savedViewsListDialogVisible" :visible="savedViewsListDialogVisible" :document="document" @close="savedViewsListDialogVisible = false" @moveView="moveView" @executeView="executeView"></DashboardSavedViewsDialog>
            <DatasetEditorPreview v-if="datasetPreviewShown" :visible="datasetPreviewShown" :prop-dataset="datasetToPreview" :dashboard-id="document.dashboardId" @close="datasetPreviewShown = false" />
        </div>
    </div>
</template>

<script lang="ts">
import { defineComponent } from 'vue'
import { AxiosResponse } from 'axios'
import { iParameter } from '@/components/UI/KnParameterSidebar/KnParameterSidebar'
import { iURLData, iExporter, iSchedulation, ICrossNavigationBreadcrumb, ICrossNavigationParameter } from './DocumentExecution'
import { createToolbarMenuItems } from './DocumentExecutionHelpers'
import { emitter } from '../dashboard/DashboardHelpers'
import { mapState, mapActions } from 'pinia'
import { getCorrectRolesForExecution } from '../../../helpers/commons/roleHelper'
import { executeAngularCrossNavigation, loadCrossNavigation } from './DocumentExecutionAngularCrossNavigationHelper'
import { getDocumentForCrossNavigation, getSelectedCrossNavigation, updateBreadcrumbForCrossNavigation } from './DocumentExecutionCrossNavigationHelper'
import { loadFilters, formatDriversUsingDashboardView } from './DocumentExecutionDriverHelpers'
import { IDashboardCrossNavigation, IDashboardView } from '../dashboard/Dashboard'
import { clearIndexedDBCache } from '../dashboard/DashboardDataProxy'
import { luxonFormatDate } from '@/helpers/commons/localeHelper'
import { downloadDirectFromResponse } from '@/helpers/commons/fileHelper'
import DocumentExecutionBreadcrumb from './breadcrumbs/DocumentExecutionBreadcrumb.vue'
import DocumentExecutionHelpDialog from './dialogs/documentExecutionHelpDialog/DocumentExecutionHelpDialog.vue'
import DocumentExecutionRankDialog from './dialogs/documentExecutionRankDialog/DocumentExecutionRankDialog.vue'
import DocumentExecutionNotesDialog from './dialogs/documentExecutionNotesDialog/DocumentExecutionNotesDialog.vue'
import DocumentExecutionMetadataDialog from './dialogs/documentExecutionMetadataDialog/DocumentExecutionMetadataDialog.vue'
import DocumentExecutionMailDialog from './dialogs/documentExecutionMailDialog/DocumentExecutionMailDialog.vue'
import DocumentExecutionSchedulationsTable from './tables/documentExecutionSchedulationsTable/DocumentExecutionSchedulationsTable.vue'
import DocumentExecutionLinkDialog from './dialogs/documentExecutionLinkDialog/DocumentExecutionLinkDialog.vue'
import KnParameterSidebar from '@/components/UI/KnParameterSidebar/KnParameterSidebar.vue'
import TieredMenu from 'primevue/tieredmenu'
import Registry from '../registry/Registry.vue'
import Dossier from '../dossier/Dossier.vue'
import Olap from '../olap/Olap.vue'
import DocumentExecutionSelectCrossNavigationDialog from './dialogs/documentExecutionSelectCrossNavigationDialog/DocumentExecutionSelectCrossNavigationDialog.vue'
import DocumentExecutionCNContainerDialog from './dialogs/documentExecutionCNContainerDialog/DocumentExecutionCNContainerDialog.vue'
import mainStore from '../../../App.store'
import dashboardStore from '../dashboard/Dashboard.store'
import deepcopy from 'deepcopy'
import DashboardController from '../dashboard/DashboardController.vue'
import Dialog from 'primevue/dialog'
import descriptor from './DocumentExecutionDescriptor.json'
import UserFunctionalitiesConstants from '@/UserFunctionalitiesConstants.json'
import WorkspaceFolderPickerDialog from './dialogs/workspaceFolderPickerDialog/WorkspaceFolderPickerDialog.vue'
import EnginesConstants from '@/EnginesConstants.json'
import DashboardSaveViewDialog from '../dashboard/DashboardViews/DashboardSaveViewDialog/DashboardSaveViewDialog.vue'
import DashboardSavedViewsDialog from '../dashboard/DashboardViews/DashboardSavedViewsDialog/DashboardSavedViewsDialog.vue'
import DatasetEditorPreview from '../dashboard/dataset/DatasetEditorDataTab/DatasetEditorPreview.vue'

let seeAsFinalUserWarning
// @ts-ignore
// eslint-disable-next-line
window.execExternalCrossNavigation = function (outputParameters, otherOutputParameters, crossNavigationLabel) {
    postMessage(
        {
            type: 'crossNavigation',
            outputParameters: outputParameters,
            inputParameters: {},
            targetCrossNavigation: crossNavigationLabel,
            docLabel: null,
            otherOutputParameters: otherOutputParameters ? [otherOutputParameters] : []
        },
        location.origin
    )
}

// @ts-ignore
// eslint-disable-next-line
window.execPreviewDataset = function (dsLabel, parameters, directDownload) {
    postMessage(
        {
            type: 'preview',
            dsLabel: dsLabel,
            parameters: parameters,
            directDownload: directDownload
        },
        location.origin
    )
}

export default defineComponent({
    name: 'document-execution',
    components: {
        DatasetEditorPreview,
        DocumentExecutionBreadcrumb,
        DocumentExecutionHelpDialog,
        DocumentExecutionRankDialog,
        DocumentExecutionNotesDialog,
        DocumentExecutionMetadataDialog,
        DocumentExecutionMailDialog,
        DocumentExecutionSchedulationsTable,
        DocumentExecutionLinkDialog,
        KnParameterSidebar,
        TieredMenu,
        Registry,
        Dossier,
        Olap,
        DocumentExecutionSelectCrossNavigationDialog,
        DocumentExecutionCNContainerDialog,
        DashboardController,
        Dialog,
        WorkspaceFolderPickerDialog,
        DashboardSaveViewDialog,
        DashboardSavedViewsDialog
    },
    props: {
        id: { type: String },
        parameterValuesMap: { type: Object },
        tabKey: { type: String },
        propMode: { type: String },
        selectedMenuItem: { type: Object },
        menuItemClickedTrigger: { type: Boolean },
        propCrossNavigationPopupDialogDocument: { type: Object }
    },
    emits: ['close', 'updateDocumentName', 'parametersChanged'],
    data() {
        return {
            descriptor,
            EnginesConstants,
            managementOpened: false,
            document: null as any,
            hiddenFormData: {} as any,
            hiddenFormUrl: '' as string,
            documentMode: 'VIEW',
            filtersData: {} as {
                filterStatus: iParameter[]
                isReadyForExecution: boolean
            },
            urlData: null as iURLData | null,
            exporters: null as iExporter[] | null,
            mode: null as string | null,
            parameterSidebarVisible: false,
            toolbarMenuItems: [] as any[],
            helpDialogVisible: false,
            documentRank: null as string | null,
            rankDialogVisible: false,
            notesDialogVisible: false,
            metadataDialogVisible: false,
            mailDialogVisible: false,
            metadata: {} as any,
            schedulationsTableVisible: false,
            schedulations: [] as any[],
            linkDialogVisible: false,
            linkInfo: null as {
                isPublic: boolean
                noPublicRoleError: boolean
            } | null,
            sbiExecutionId: null as string | null,
            embedHTML: false,
            reloadTrigger: false,
            breadcrumbs: [] as ICrossNavigationBreadcrumb[],
            embed: false,
            olapCustomViewVisible: false,
            userRole: null as string | null,
            loading: false,
            olapDesignerMode: false,
            sessionEnabled: false,
            dateFormat: '' as string,
            destinationSelectDialogVisible: false,
            crossNavigationDocuments: [] as any[],
            angularData: null as any,
            crossNavigationContainerVisible: false,
            crossNavigationContainerData: null as any,
            newCockpitCreated: false,
            newDashboardMode: false,
            dashboardGeneralSettingsOpened: false,
            crossNavigationPayload: null as {
                documentCrossNavigationOutputParameters: ICrossNavigationParameter[]
                crossNavigationName: string | undefined
                crossNavigations: IDashboardCrossNavigation[]
            } | null,
            crossNavigationPopupDialogDocument: null as any,
            crossNavigationDialogVisible: false,
            loadingCrossNavigationDocument: false,
            crossNavigationSourceDocumentName: '',
            dashboardView: null as IDashboardView | null,
            workspaceFolderPickerDialogVisible: false,
            metadataLoading: false,
            saveViewDialogVisible: false,
            savedViewsListDialogVisible: false,
            currentCockpitView: { label: '', name: '', description: '', drivers: {}, settings: { states: {} }, visibility: 'public', new: true } as IDashboardView,
            selectedCockpitView: null as IDashboardView | null,
            cockpitViewForExecution: null as IDashboardView | null,
            dataLoaded: false,
            seeAsFinalUser: false,
            downloadMode: false,
            datasetPreviewShown: false as boolean,
            datasetToPreview: {} as any
        }
    },
    computed: {
        ...mapState(mainStore, {
            user: 'user',
            configurations: 'configurations'
        }),
        ...mapState(dashboardStore, {
            dashboards: 'dashboards'
        }),
        canEditCockpit(): boolean {
            if (!this.user || !this.document) return false
            return (this.document.engine?.toLowerCase() === 'knowagecockpitengine' || this.document.engine?.toLowerCase() === 'knowagedashboardengine') && (this.user.functionalities?.includes(UserFunctionalitiesConstants.DOCUMENT_ADMIN_MANAGEMENT) || this.document.creationUser === this.user.userId)
        },
        sessionRole(): string | null {
            if (!this.user) return null
            return this.user.sessionRole !== this.$t('role.defaultRolePlaceholder') ? this.user.sessionRole : null
        },
        url(): string {
            return this.document
                ? `${import.meta.env.VITE_HOST_URL}${import.meta.env.VITE_KNOWAGE_CONTEXT}/restful-services/publish?PUBLISHER=documentExecutionNg&OBJECT_ID=${this.document.id}&OBJECT_LABEL=${
                      this.document.label
                  }&TOOLBAR_VISIBLE=false&MENU_PARAMETERS=%7B%7D&LIGHT_NAVIGATOR_DISABLED=TRUE&SBI_EXECUTION_ID=${this.sbiExecutionId}&OBJECT_NAME=${this.document.name}&CROSS_PARAMETER=null`
                : ''
        },
        isParameterSidebarVisible(): boolean {
            if (!this.userRole) return false
            let parameterVisible = false
            for (let i = 0; i < this.filtersData?.filterStatus?.length; i++) {
                const tempFilter = this.filtersData.filterStatus[i]
                if (tempFilter.showOnPanel === 'true' && tempFilter.visible) {
                    parameterVisible = true
                    break
                }
            }
            return parameterVisible
        },
        showExecutedDocument() {
            return this.filtersData && this.filtersData.isReadyForExecution && !this.loading && !this.schedulationsTableVisible
        },
        showToolbar() {
            if (this.$route.query.toolbar !== 'false') {
                return !this.embed && !this.olapDesignerMode && !this.managementOpened && !this.dashboardGeneralSettingsOpened
            } else {
                return this.propMode === 'document-execution-cross-navigation-popup'
            }
        },
        isInDocBrowser() {
            return this.propMode === 'document-execution-cross-navigation-popup' || this.$route.matched.some((i) => i.name === 'document-browser' || i.name === 'document-execution-workspace')
        },
        isMobileDevice() {
            return /Android|iPhone/i.test(navigator.userAgent)
        }
    },
    watch: {
        async menuItemClickedTrigger() {
            if (!this.selectedMenuItem) return
            const routes = ['registry', 'document-composite', 'report', 'office-doc', 'olap', 'map', 'report', 'kpi', 'dossier', 'etl']
            const test = routes.some((el) => this.selectedMenuItem?.to.includes(el))
            if (!test) return
            const label = this.selectedMenuItem.to.substring(this.selectedMenuItem.to.lastIndexOf('/') + 1)
            this.document = { label: label }
            if (!this.document.label) return
            this.breadcrumbs = []
            this.filtersData = {} as any
            await this.loadDocument()
            this.userRole ? await this.loadPage(true) : (this.parameterSidebarVisible = true)
        }
    },
    async activated() {
        if (this.mode === 'iframe' && this.$route.name !== 'new-dashboard') this.userRole ? await this.loadPage(true) : (this.parameterSidebarVisible = true)
    },
    deactivated() {
        this.parameterSidebarVisible = false
        window.removeEventListener('message', this.iframeEventsListener)
    },
    async created() {
        this.setEventListeners()
        window.addEventListener('message', this.iframeEventsListener)

        if (this.propCrossNavigationPopupDialogDocument) {
            this.document = this.propCrossNavigationPopupDialogDocument
            await this.loadUserConfig()
            this.setMode()
        } else {
            if (this.propMode !== 'document-execution' && !this.$route.path.includes('olap-designer') && this.$route.name !== 'document-execution' && this.$route.name !== 'document-execution-embed' && this.$route.name !== 'document-execution-workspace') return
            if (this.$route.name === 'new-dashboard') this.newDashboardMode = true

            await this.loadUserConfig()
            this.isOlapDesignerMode()
            this.setMode()
            this.document = { label: this.id }
            if (this.newDashboardMode)
                this.breadcrumbs.push({
                    label: 'new-dashboard',
                    document: this.document
                })
            if (!this.document.label) return
            if (this.document.label === 'new-dashboard') {
                this.newDashboardMode = true
                return
            }
            await this.loadDocument()
        }

        if (this.$route.query.viewName) await this.loadView()
        if (this.$route.query.role) this.userRole = '' + this.$route.query.role
        else this.userRole = this.user?.sessionRole !== this.$t('role.defaultRolePlaceholder') ? this.user?.sessionRole : null
        if (this.$route.query.finalUser) {
            this.document.seeAsFinalUser = true
            this.seeAsFinalUser = true
        }

        let invalidRole = false
        getCorrectRolesForExecution(this.document).then(async (response: any) => {
            const correctRolesForExecution = response

            if (!this.userRole) {
                if (correctRolesForExecution.length == 1) {
                    this.userRole = correctRolesForExecution[0]
                } else {
                    this.parameterSidebarVisible = true
                }
            } else if (this.userRole) {
                if (correctRolesForExecution.length == 1) {
                    const correctRole = correctRolesForExecution[0]
                    if (this.userRole !== correctRole) {
                        this.setError({
                            title: this.$t('common.error.generic'),
                            msg: this.$t('documentExecution.main.userRoleError')
                        })
                        invalidRole = true
                    }
                }
            }
            if (!invalidRole && !this.dataLoaded) this.userRole ? await this.loadPage(true) : (this.parameterSidebarVisible = true)
        })
    },
    unmounted() {
        this.removeEventListeners()
    },
    methods: {
        canSeeDashboardFunctions() {
            if (this.seeAsFinalUser) return false
            if (!this.user || !this.document) return false
            if (!this.document.dashboardId && this.document.crossType != 1) return true
            else return this.user.functionalities?.includes(UserFunctionalitiesConstants.DOCUMENT_ADMIN_MANAGEMENT) || this.document.creationUser === this.user.userId
        },
        ...mapActions(mainStore, ['setInfo', 'setLoading', 'setError', 'setDocumentExecutionEmbed']),

        prepareDriversAndParameter(parameters: any) {
            let tempObj = {} as any
            if (parameters.length > 0) {
                const tempParams = parameters.map((i) => {
                    return {
                        name: i.name,
                        multiValue: i.multiValue,
                        value: i.value
                    }
                })
                tempObj.parameters = tempParams
            }
            if (this.filtersData?.filterStatus.length > 0) {
                let tempDrivers = {} as any
                this.filtersData.filterStatus.forEach((i) => {
                    tempDrivers[i.urlName] = i.parameterValue.length > 1 ? i.parameterValue.map((p) => p.value) : i.parameterValue[0].value
                })
                tempObj.drivers = tempDrivers
            }
            return tempObj
        },
        async directDownloadDataset(dataset: any) {
            await this.$http
                .post(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/2.0/export/dataset/${dataset.id}/csv`, this.prepareDriversAndParameter(dataset.pars), { headers: { Accept: 'application/json, text/plain, */*', 'Content-Type': 'application/json;charset=UTF-8' } })
                .then(() => this.setInfo({ title: this.$t('common.toast.updateTitle'), msg: this.$t('workspace.myData.exportSuccess') }))
                .catch(() => {})
        },
        async iframeEventsListener(event) {
            if (event.data.type === 'crossNavigation') {
                executeAngularCrossNavigation(this, event, this.$http)
            } else if (event.data.type === 'preview') {
                await this.$http
                    .get(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/1.0/datasets/${event.data.dsLabel}`)
                    .then((response: AxiosResponse<any>) => {
                        this.datasetToPreview = response.data[0]
                        if (event.data.parameters && event.data.parameters.length > 0) {
                            this.datasetToPreview.pars.forEach((i) => {
                                if (Object.keys(event.data.parameters[0]).includes(i.name)) {
                                    i.value = event.data.parameters[0][i.name]
                                }
                            })
                        }
                    })
                    .catch(() => {})
                if (event.data.directDownload) this.directDownloadDataset(this.datasetToPreview)
                else this.datasetPreviewShown = true
            } else if (event.data.type === 'cockpitExecuted') {
                this.loading = false
            }
        },
        editCockpitDocumentConfirm() {
            this.documentMode === 'EDIT'
                ? this.$confirm.require({
                      message: this.$t('documentExecution.main.editModeConfirm'),
                      header: this.$t('documentExecution.main.editCockpit'),
                      icon: 'pi pi-exclamation-triangle',
                      accept: () => this.editCockpitDocument()
                  })
                : this.editCockpitDocument()
        },
        async editCockpitDocument() {
            this.loading = true
            this.documentMode = this.documentMode === 'EDIT' ? 'VIEW' : 'EDIT'
            this.hiddenFormData.set('documentMode', this.documentMode)
            await this.loadURL(null)
        },
        openHelp() {
            this.helpDialogVisible = true
        },
        async clearCache() {
            clearIndexedDBCache()
            if (this.document.dashboardId) {
                const payload = {}
                const datasets = this.dashboards[this.document.dashboardId].configuration.datasets
                datasets.forEach((ds) => {
                    payload[ds.dsLabel] = {}
                    if (ds.parameters && ds.parameters.length > 0) {
                        ds.parameters.forEach((par) => {
                            payload[ds.dsLabel][par.name] = par.value
                        })
                    }
                })
                await this.$http.post(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/1.0/cache/clean-datasets`, payload).then(() => this.setInfo({ title: this.$t('documentExecution.main.clearCache'), msg: this.$t('documentExecution.main.cacheCleared') }))
            }
            this.document
        },
        async refresh() {
            this.parameterSidebarVisible = false
            await this.loadURL(null)
            this.reloadTrigger = !this.reloadTrigger
        },
        toggle(event: Event) {
            this.createMenuItems()
            const menu = this.$refs.menu as any
            menu.toggle(event)
        },
        createMenuItems() {
            this.toolbarMenuItems = createToolbarMenuItems(
                this.document,
                {
                    print: this.print,
                    openRank: this.openRank,
                    export: this.export,
                    openMailDialog: this.openMailDialog,
                    openMetadata: this.openMetadata,
                    openNotes: this.openNotes,
                    showScheduledExecutions: this.showScheduledExecutions,
                    addToWorkspace: this.addToWorkspace,
                    showOLAPCustomView: this.showOLAPCustomView,
                    copyLink: this.copyLink,
                    openDashboardGeneralSettings: this.openDashboardGeneralSettings,
                    openSaveCurrentViewDialog: this.openSaveCurrentViewDialog,
                    openSavedViewsListDialog: this.openSavedViewsListDialog,
                    openHelp: this.openHelp,
                    fullScreen: this.fullScreen,
                    toggleFinalUser: this.toggleFinalUser,
                    clearCache: this.clearCache
                },
                this.exporters,
                this.user,
                this.isOrganizerEnabled(),
                this.mode,
                this.$t,
                this.newDashboardMode,
                this.filtersData
            )
        },
        print() {
            window.print()
        },
        hiddenExport(type: string) {
            this.export(type)
        },
        async export(type: string) {
            if (this.document.typeCode === 'OLAP') {
                this.exportOlap(type)
            } else if (this.document.typeCode === 'REPORT') {
                window.open(this.urlData?.url + '&outputType=' + type, 'name', 'resizable=1,height=750,width=1000')
            } else if (this.document.typeCode === 'DATAMART') {
                await this.exportRegistry(type.toLowerCase())
            } else if (type === 'PDF' && this.document.typeCode != 'DOCUMENT_COMPOSITE') {
                await this.asyncExport('pdf')
            } else if (type === 'XLSX' && this.document.typeCode != 'DOCUMENT_COMPOSITE') {
                await this.asyncExport('xlsx')
            } else if (type === 'PNG' && this.document.typeCode != 'DOCUMENT_COMPOSITE') {
                await this.asyncExport('png')
            } else {
                const filteredFrames = Array.prototype.filter.call(window.frames, (frame) => frame.name)
                const tempIndex = this.breadcrumbs.findIndex((el: any) => el.label === this.document.name)

                let tempFrame = filteredFrames[tempIndex]
                if (tempFrame && tempFrame.name === 'documentFrame' + tempIndex) {
                    tempFrame.postMessage({ type: 'export', format: type.toLowerCase() }, '*')
                    return
                }

                while (tempFrame && tempFrame.name !== 'documentFrame' + tempIndex) tempFrame = tempFrame[0].frames

                tempFrame.postMessage({ type: 'export', format: type.toLowerCase() }, '*')
            }
        },
        exportOlap(type: string) {
            const url =
                type === 'PDF'
                    ? `${import.meta.env.VITE_HOST_URL}${import.meta.env.VITE_KNOWAGEWHATIF_CONTEXT}/restful-services/1.0/model/export/pdf?SBI_EXECUTION_ID=${this.sbiExecutionId}`
                    : `${import.meta.env.VITE_HOST_URL}${import.meta.env.VITE_KNOWAGEWHATIF_CONTEXT}/restful-services/1.0/model/export/excel?SBI_EXECUTION_ID=${this.sbiExecutionId}`
            window.open(url)
        },
        async exportRegistry(format) {
            this.setLoading(true)
            await this.$http
                .get(import.meta.env.VITE_KNOWAGEQBE_CONTEXT + `/restful-services/1.0/export/registry/${format.includes('xls') ? 'spreadsheet' : format}?SBI_EXECUTION_ID=${this.urlData?.sbiExecutionId}`, {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        Accept: 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9'
                    }
                })
                .then((response) => {
                    downloadDirectFromResponse(response)
                })
                .finally(() => this.setLoading(false))
        },
        async asyncExport(format) {
            this.setLoading(true)
            await this.$http
                .post(import.meta.env.VITE_KNOWAGECOCKPITENGINE_CONTEXT + `/api/1.0/pages/execute/${format.includes('xls') ? 'spreadsheet' : format}`, this.hiddenFormData, {
                    responseType: 'blob',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        Accept: 'text/html,application/xhtml+xml,application/xml;application/pdf;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9'
                    }
                })
                .then((response) => {
                    downloadDirectFromResponse(response)
                })
                .finally(() => this.setLoading(false))
        },
        openMailDialog() {
            this.mailDialogVisible = true
        },
        async openMetadata() {
            this.metadataLoading = true
            await this.$http.get(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/1.0/documentexecutionee/${this.document.id}/documentMetadata`).then((response: AxiosResponse<any>) => (this.metadata = response.data))
            this.metadataDialogVisible = true
            this.metadataLoading = false
        },
        async openRank() {
            await this.getRank()
            this.rankDialogVisible = true
        },
        openNotes() {
            this.notesDialogVisible = true
        },
        async showScheduledExecutions() {
            this.loading = true
            this.parameterSidebarVisible = false
            this.schedulationsTableVisible = true
            await this.$http
                .get(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/1.0/documentsnapshot/getSnapshots?id=${this.document.id}`)
                .then((response: AxiosResponse<any>) => response.data?.schedulers.forEach((el: any) => this.schedulations.push({ ...el, urlPath: response.data.urlPath })))
            this.loading = false
        },
        async copyLink(embedHTML: boolean) {
            this.loading = true
            await this.$http
                .post(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/1.0/documentexecution/canHavePublicExecutionUrl`, { label: this.document.label })
                .then((response: AxiosResponse<any>) => {
                    this.embedHTML = embedHTML
                    this.linkInfo = response.data
                    this.linkDialogVisible = true
                })
                .catch(() => {})
            this.loading = false
        },
        closeDocumentConfirm() {
            if (this.documentMode === 'EDIT') {
                this.$confirm.require({
                    message: this.$t('documentExecution.main.closeDocumentConfirmMessage'),
                    header: this.$t('documentExecution.main.closeDocumentConfirmTitle'),
                    icon: 'pi pi-exclamation-triangle',
                    accept: () => this.closeDocument()
                })
            } else {
                this.closeDocument()
            }
        },
        closeDocument() {
            if (this.propMode !== 'document-execution-cross-navigation-popup') {
                this.$router.push(this.$route.path.includes('workspace') ? '/workspace' : '/document-browser')
                this.breadcrumbs = []
            }
            if (this.newDashboardMode) emitter.emit('newDashboardClosed', this.document.dashboardId)
            this.$emit('close')
        },
        setMode() {
            this.embed = this.$route.path.includes('embed')
            if (this.embed) this.setDocumentExecutionEmbed()
            if (this.$route.path.includes('registry')) this.mode = 'registry'
            else if (this.$route.path.includes('dossier')) this.mode = 'dossier'
            else if (this.$route.path.includes('olap')) this.mode = 'olap'
            else if (this.$route.path.includes('dashboard')) this.mode = 'dashboard'
            else this.mode = 'iframe'
        },
        async loadPage(initialLoading = false, documentLabel: string | null = null, crossNavigationPopupMode = false) {
            this.loading = crossNavigationPopupMode ? false : true
            if (!this.userRole) {
                this.parameterSidebarVisible = true
                return
            }
            this.filtersData = await loadFilters(initialLoading, this.filtersData, this.document, this.breadcrumbs, this.userRole, this.parameterValuesMap, this.tabKey as string, this.sessionEnabled, this.$http, this.dateFormat, this.$route, this)
            if (this.dashboardView) formatDriversUsingDashboardView(this.filtersData, this.dashboardView)
            else if (this.cockpitViewForExecution) formatDriversUsingDashboardView(this.filtersData, this.cockpitViewForExecution)
            if (this.filtersData?.isReadyForExecution) {
                this.parameterSidebarVisible = false
                await this.loadURL(null, documentLabel, crossNavigationPopupMode)
                await this.loadExporters()
            } else if (this.filtersData?.filterStatus) {
                this.parameterSidebarVisible = true
            }
            this.updateMode(true)
            if (this.$route.query.outputType && ['png', 'xls', 'xlsx', 'pdf'].includes(this.$route.query.outputType.toLowerCase())) {
                this.downloadMode = true
                await this.asyncExport(this.$route.query.outputType.toLowerCase())
                return
            }
            this.loading = false
        },
        updateMode(refresh = false) {
            if (this.document.typeCode === 'DATAMART') this.mode = 'registry'
            else if (this.document.typeCode === 'DOSSIER') this.mode = 'dossier'
            else if (this.document.typeCode === 'OLAP') this.mode = 'olap'
            else if ((this.document.typeCode === 'DOCUMENT_COMPOSITE' && this.$route.path.includes('dashboard')) || this.document.typeCode === 'DASHBOARD') {
                this.mode = 'dashboard'
                if (refresh) this.reloadTrigger = !this.reloadTrigger
            } else this.mode = 'iframe'
        },
        async loadDocument() {
            await this.$http.get(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/2.0/documents/${this.document?.label}`).then((response: AxiosResponse<any>) => (this.document = response.data))
            const index = this.breadcrumbs.findIndex((el: any) => el.label === this.document.name)
            index !== -1
                ? (this.breadcrumbs[index].document = this.document)
                : this.breadcrumbs.push({
                      label: this.document.name,
                      document: this.document
                  })
        },
        async loadView() {
            this.loading = true
            await this.$http
                .get(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/1.0/repository/view/${this.$route.query.viewId}`)
                .then(async (response: AxiosResponse<any>) => {
                    this.$route.path.includes('cockpit-view') ? (this.cockpitViewForExecution = response.data) : (this.dashboardView = response.data)
                    if (this.cockpitViewForExecution) await this.executeView(this.cockpitViewForExecution)
                })
                .catch(() => {})
            this.loading = false
        },
        async loadURL(olapParameters: any, documentLabel: string | null = null, crossNavigationPopupMode = false) {
            let error = false
            const postData = {
                label: this.document.label,
                role: this.userRole,
                parameters: olapParameters ? olapParameters : this.getFormattedParameters(),
                EDIT_MODE: this.documentMode ? this.documentMode : 'null',
                IS_FOR_EXPORT: true,
                SBI_EXECUTION_ID: ''
            } as any
            if (this.sbiExecutionId) postData.SBI_EXECUTION_ID = this.sbiExecutionId
            if (this.document.typeCode === 'MAP') postData.EDIT_MODE = 'edit_map'
            await this.$http
                .post(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/1.0/documentexecution/url`, postData)
                .then((response: AxiosResponse<any>) => {
                    error = false
                    this.urlData = response.data
                    this.sbiExecutionId = this.urlData?.sbiExecutionId as string
                })
                .catch((response: AxiosResponse<any>) => {
                    error = true
                    this.urlData = response.data
                    this.sbiExecutionId = this.urlData?.sbiExecutionId as string
                })

            const index = this.breadcrumbs.findIndex((el: any) => el.label === this.document.name)
            if (index !== -1) {
                this.breadcrumbs[index].urlData = this.urlData
                this.sbiExecutionId = this.urlData?.sbiExecutionId as string
            }
            if (error) return
            await this.sendForm(documentLabel, crossNavigationPopupMode)
        },
        async loadExporters() {
            if (!this.urlData || !this.urlData.engineLabel) return
            const engineLabel = this.urlData.engineLabel
            if (engineLabel !== EnginesConstants.DOSSIER_ENGINE) {
                await this.$http.get(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/2.0/exporters/${engineLabel}`).then((response: AxiosResponse<any>) => (this.exporters = response.data.exporters))
            }
        },
        replaceOldFormat(formValue) {
            return formValue
                .replace(/{;{(.*)}STRING}/gm, (m, g1) => {
                    return g1
                })
                .split(';')
        },
        replaceNullForDates(par,value){
            if(value == 'null' && this.filtersData.filterStatus.find((i)=>i.urlName === par && i.type === 'DATE')){
                return '' 
            }else return value
        },
        async sendForm(documentLabel: string | null = null, crossNavigationPopupMode = false) {
            const tempIndex = this.breadcrumbs.findIndex((el: any) => el.label === this.document.name) as any
            const documentUrl = this.urlData?.url + '&timereloadurl=' + new Date().getTime()
            const postObject = {
                params: { document: null } as any,
                url: documentUrl.split('?')[0]
            }
            if (this.$route.query.documentMode === 'edit' && !this.newCockpitCreated) this.documentMode = 'EDIT'
            postObject.params.documentMode = this.documentMode
            this.newCockpitCreated = true
            this.hiddenFormUrl = postObject.url
            const paramsFromUrl = documentUrl?.split('?')[1]?.split('&')

            for (const i in paramsFromUrl) {
                if (typeof paramsFromUrl !== 'function') postObject.params[paramsFromUrl[i].split('=')[0]] = paramsFromUrl[i].split('=')[1]
            }

            let postForm = document.getElementById('postForm_' + postObject.params.document) as any
            if (!postForm) postForm = document.createElement('form')
            postForm.id = 'postForm_' + postObject.params.document
            postForm.action = import.meta.env.VITE_HOST_URL + postObject.url
            postForm.method = 'post'
            const iframeName = crossNavigationPopupMode ? 'documentFramePopup' : 'documentFrame'
            if (this.isMobileDevice && postObject.params.outputType?.toLowerCase() === 'pdf') postForm.target = '_blank'
            else postForm.target = tempIndex !== -1 ? iframeName + tempIndex : documentLabel
            postForm.acceptCharset = 'UTF-8'
            document.body.appendChild(postForm)

            this.hiddenFormData = new URLSearchParams()

            for (const k in postObject.params) {
                const inputElement = document.getElementById(`postForm_${postObject.params.document}${k}`) as any
                if (inputElement) {
                    if (this.document.typeCode === 'DASHBOARD' && decodeURIComponent(postObject.params[k]).match(/^{;{/gm)) {
                        var multipleElements = document.getElementsByClassName(`multiple_${k}`)
                        while (multipleElements.length > 0) {
                            this.hiddenFormData.delete(k, multipleElements[0].value)
                            multipleElements[0].parentNode.removeChild(multipleElements[0])
                        }
                        var tempValues = this.replaceOldFormat(decodeURIComponent(postObject.params[k]))
                        tempValues.forEach((i) => {
                            const element = document.createElement('input')
                            element.type = 'hidden'
                            element.id = 'postForm_' + postObject.params.document + k
                            element.name = k
                            element.value = this.replaceNullForDates(k,i)
                            element.classList.add(`multiple_${k}`)
                            postForm.appendChild(element)
                            this.hiddenFormData.append(element.name, element.value)
                        })
                    } else {
                        inputElement.value = decodeURIComponent(postObject.params[k])
                        inputElement.value = inputElement.value.replace(/\+/g, ' ')
                        inputElement.value = this.replaceNullForDates(k,inputElement.value)
                        this.hiddenFormData.set(k, decodeURIComponent(postObject.params[k]).replace(/\+/g, ' '))
                    }
                } else {
                    if (this.document.typeCode === 'DASHBOARD' && decodeURIComponent(postObject.params[k]).match(/^{;{/gm)) {
                        var tempValues = this.replaceOldFormat(decodeURIComponent(postObject.params[k]))
                        tempValues.forEach((i) => {
                            const element = document.createElement('input')
                            element.type = 'hidden'
                            element.id = 'postForm_' + postObject.params.document + k
                            element.name = k
                            element.value = this.replaceNullForDates(k,i)
                            element.classList.add(`multiple_${k}`)
                            postForm.appendChild(element)
                            this.hiddenFormData.append(element.name, element.value)
                        })
                    } else {
                        const element = document.createElement('input')
                        element.type = 'hidden'
                        element.id = 'postForm_' + postObject.params.document + k
                        element.name = k
                        element.value = decodeURIComponent(postObject.params[k].replace(/\+/g, ' '))
                        element.value = this.replaceNullForDates(k,element.value)
                        postForm.appendChild(element)
                        this.hiddenFormData.append(element.name, element.value)
                    }
                }
            }

            if (this.document.typeCode != 'DASHBOARD') {
                for (let i = postForm.elements.length - 1; i >= 0; i--) {
                    const postFormElement = postForm.elements[i].id.replace('postForm_' + postObject.params.document, '')
                    if (!(postFormElement in postObject.params)) {
                        postForm.removeChild(postForm.elements[i])
                        this.hiddenFormData.delete(postFormElement)
                    }
                }
            }

            this.hiddenFormData.append('documentMode', this.documentMode)
            if (this.document.typeCode === 'DASHBOARD') return
            this.document.typeCode === 'DATAMART' || this.document.typeCode === 'DOSSIER' || this.document.typeCode === 'OLAP' || (['DOCUMENT_COMPOSITE'].includes(this.document.typeCode) && this.mode === 'dashboard') ? await this.sendHiddenFormData() : postForm.submit()
            const index = this.breadcrumbs.findIndex((el: any) => el.label === this.document.name)
            if (index !== -1) this.breadcrumbs[index].hiddenFormData = this.hiddenFormData
        },
        async sendHiddenFormData() {
            await this.$http
                .post(this.hiddenFormUrl, this.hiddenFormData, {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        Accept: 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9'
                    }
                })
                .then(() => {})
                .catch(() => {})
        },
        async onExecute() {
            this.loading = true
            this.filtersData.isReadyForExecution = true
            await this.loadURL(null)
            this.parameterSidebarVisible = false
            this.reloadTrigger = !this.reloadTrigger
            if (!this.exporters || this.exporters.length === 0) {
                await this.loadExporters()
                const index = this.toolbarMenuItems.findIndex((item: any) => item.label === this.$t('common.export'))
                index === -1
                    ? this.toolbarMenuItems.splice(1, 0, {
                          label: this.$t('common.export'),
                          items: []
                      })
                    : this.exporters?.forEach((exporter: any) =>
                          this.toolbarMenuItems[index].items.push({
                              icon: 'fa fa-file-excel',
                              label: exporter.name,
                              command: () => this.export(exporter.name)
                          })
                      )
            }
            if (this.sessionEnabled) this.saveParametersInSession()
            this.loading = false
        },
        async onExportCSV() {
            const postData = {
                documentId: this.document.id,
                documentLabel: this.document.label,
                exportType: 'CSV',
                parameters: this.getFormattedParametersForCSVExport()
            }
            this.loading = true
            await this.$http
                .post(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/2.0/export/cockpitData`, postData)
                .then(() =>
                    this.setInfo({
                        title: this.$t('common.toast.updateTitle'),
                        msg: this.$t('common.exportSuccess')
                    })
                )
                .catch(() => {})
            this.loading = false
        },
        getFormattedParameters() {
            if (!this.filtersData || !this.filtersData.filterStatus) return {}
            const parameters = {} as any
            Object.keys(this.filtersData.filterStatus).forEach((key: any) => {
                const parameter = this.filtersData.filterStatus[key]
                if (parameter.parameterValue) {
                    if (parameter.type === 'DATE' && parameter.parameterValue[0] && parameter.parameterValue[0].value) {
                        parameters[parameter.urlName] = this.getFormattedDate(parameter.parameterValue[0].value)
                        parameters[parameter.urlName + '_field_visible_description'] = this.getFormattedDate(parameter.parameterValue[0].value, true)
                    } else if (parameter.valueSelection === 'man_in') {
                        if (!parameter.parameterValue[0]) parameter.parameterValue[0] = { value: '', description: '' }
                        parameters[parameter.urlName] = parameter.type === 'NUM' && parameter.parameterValue[0].value ? +parameter.parameterValue[0].value : parameter.parameterValue[0].value
                        parameters[parameter.urlName + '_field_visible_description'] = parameter.type === 'NUM' && parameter.parameterValue[0].description ? +parameter.parameterValue[0].description : parameter.parameterValue[0].description
                    } else if (parameter.selectionType === 'TREE' || parameter.selectionType === 'LOOKUP' || parameter.multivalue) {
                        parameters[parameter.urlName] = parameter.parameterValue.map((el: any) => {
                            if (typeof el.value === 'object') return el.value[0]
                            else return el.value
                        })
                        let tempString = ''
                        for (let i = 0; i < parameter.parameterValue.length; i++) {
                            tempString += parameter.parameterValue[i].description
                            tempString += i === parameter.parameterValue.length - 1 ? '' : ';'
                        }
                        parameters[parameter.urlName + '_field_visible_description'] = tempString
                    } else {
                        parameters[parameter.urlName] = parameter.parameterValue[0] ? parameter.parameterValue[0].value : ''
                        parameters[parameter.urlName + '_field_visible_description'] = parameter.parameterValue[0] ? parameter.parameterValue[0].description : ''
                    }
                }
            })
            return parameters
        },
        getFormattedParametersForCSVExport() {
            if (!this.filtersData) return {}
            const parameters = {} as any
            Object.keys(this.filtersData.filterStatus).forEach((key: any) => {
                const parameter = this.filtersData.filterStatus[key]
                if (parameter.parameterValue) {
                    if (parameter.type === 'DATE') {
                        parameters[parameter.urlName] = this.getFormattedDate(parameter.parameterValue[0].value)
                    } else if (parameter.valueSelection === 'man_in' && !parameter.multivalue) {
                        parameters[parameter.urlName] = parameter.type === 'NUM' && parameter.parameterValue[0].value ? +parameter.parameterValue[0].value : parameter.parameterValue[0].value
                    } else if (parameter.selectionType === 'TREE' || parameter.selectionType === 'LOOKUP' || parameter.multivalue) {
                        let tempString = ''
                        for (let i = 0; i < parameter.parameterValue.length; i++) {
                            tempString += parameter.parameterValue[i].value
                            tempString += i === parameter.parameterValue.length - 1 ? '' : ','
                        }
                        parameters[parameter.urlName] = tempString
                    } else {
                        parameters[parameter.urlName] = parameter.parameterValue[0].value
                    }
                }
            })
            return parameters
        },
        async getRank() {
            this.loading = true
            await this.$http
                .post(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/documentrating/getvote`, { obj: this.document.id })
                .then((response: AxiosResponse<any>) => (this.documentRank = response.data))
                .catch((error: any) => this.setError({ title: this.$t('common.error.generic'), msg: error }))
            this.loading = false
        },
        async onSaveRank(newRank: any) {
            if (newRank) {
                this.loading = true
                await this.$http
                    .post(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/documentrating/vote`, { rating: newRank, obj: this.document.id })
                    .then(() =>
                        this.setInfo({
                            title: this.$t('common.toast.updateTitle'),
                            msg: this.$t('documentExecution.main.rankSaveSucces')
                        })
                    )
                    .catch((error: any) =>
                        this.setError({
                            title: this.$t('common.error.generic'),
                            msg: error
                        })
                    )
                this.loading = false
            }
            this.rankDialogVisible = false
        },
        async onMetadataSave(metadata: any) {
            this.metadataLoading = true
            const jsonMeta = [] as any[]
            const properties = ['shortText', 'longText', 'file']
            properties.forEach((property: string) =>
                metadata[property].forEach((el: any) => {
                    if (el.value || (property === 'file' && el.fileToSave)) {
                        if (property === 'file') el.value = JSON.stringify(el.value)
                        jsonMeta.push(el)
                    }
                })
            )
            await this.$http
                .post(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/1.0/documentexecutionee/saveDocumentMetadata`, { id: this.document.id, jsonMeta: jsonMeta })
                .then(() => {
                    this.setInfo({
                        title: this.$t('common.toast.createTitle'),
                        msg: this.$t('common.toast.success')
                    })
                    this.metadataDialogVisible = false
                })
                .catch(() => {})
            this.metadataLoading = false
        },
        async onMailSave(mail: any) {
            this.loading = true
            const postData = {
                ...mail,
                label: this.document.label,
                docId: this.document.id,
                userId: this.user.userId,
                parameters: this.getFormattedParameters()
            }
            await this.$http
                .post(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/1.0/documentexecutionmail/sendMail`, postData)
                .then(() => {
                    this.setInfo({
                        title: this.$t('common.toast.createTitle'),
                        msg: this.$t('common.sendMailSuccess')
                    })
                    this.mailDialogVisible = false
                })
                .catch((error: any) => this.setError({ title: this.$t('common.error.generic'), msg: error }))
            this.loading = false
        },
        async onDeleteSchedulation(schedulation: any) {
            this.loading = true
            await this.$http
                .post(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/1.0/documentsnapshot/deleteSnapshot`, { SNAPSHOT: '' + schedulation.id })
                .then(async () => {
                    this.removeSchedulation(schedulation)
                    this.setInfo({
                        title: this.$t('common.toast.deleteTitle'),
                        msg: this.$t('common.toast.deleteSuccess')
                    })
                })
                .catch(() => {})
            this.loading = false
        },
        removeSchedulation(schedulation: iSchedulation) {
            const index = this.schedulations.findIndex((el: any) => el.id === schedulation.id)
            if (index !== -1) this.schedulations.splice(index, 1)
        },
        getFormattedDate(date: any, useDefaultFormat?: boolean) {
            const format = date instanceof Date ? undefined : 'dd/MM/yyyy'
            const formattedDate = luxonFormatDate(date, format, useDefaultFormat ? undefined : this.configurations['SPAGOBI.DATE-FORMAT-SERVER.format'])
            if (formattedDate === 'Invalid DateTime') {
                return luxonFormatDate(new Date(date), undefined, useDefaultFormat ? undefined : this.configurations['SPAGOBI.DATE-FORMAT-SERVER.format'])
            } else return formattedDate
        },
        async onBreadcrumbClick(item: any) {
            if (!item) return
            this.document = item.document
            this.filtersData = item.filtersData
            this.urlData = item.urlData
            this.hiddenFormData = item.hiddenFormData
            this.documentMode = 'VIEW'
            this.parameterSidebarVisible = !this.filtersData || this.filtersData.isReadyForExecution === false
            this.updateMode()
        },
        async onRoleChange(role: string) {
            this.userRole = role as any
            this.filtersData = {} as {
                filterStatus: iParameter[]
                isReadyForExecution: boolean
            }
            this.urlData = null
            this.exporters = null
            this.dataLoaded = true
            await this.loadPage()
        },
        setNavigationParametersFromCurrentFilters(formatedParams: any, navigationParams: any) {
            const navigationParamsKeys = navigationParams ? Object.keys(navigationParams) : []
            const formattedParameters = this.getFormattedParameters()
            const formattedParametersKeys = formattedParameters ? Object.keys(formattedParameters) : []
            if (navigationParamsKeys.length > 0 && formattedParametersKeys.length > 0) {
                for (let i = 0; i < navigationParamsKeys.length; i++) {
                    const index = formattedParametersKeys.findIndex((key: string) => key === navigationParams[navigationParamsKeys[i]].value.label && navigationParams[navigationParamsKeys[i]].value.isInput)
                    if (index !== -1) {
                        formatedParams[navigationParamsKeys[i]] = formattedParameters[formattedParametersKeys[index]]
                        formatedParams[navigationParamsKeys[i] + '_field_visible_description'] = formattedParameters[formattedParametersKeys[index] + '_field_visible_description'] ? formattedParameters[formattedParametersKeys[index] + '_field_visible_description'] : ''
                    }
                }
            }
        },
        showOLAPCustomView() {
            this.olapCustomViewVisible = true
        },
        async executeOlapCustomView(payload: any) {
            this.loading = true
            this.olapCustomViewVisible = false
            await this.loadURL(payload)
            this.reloadTrigger = !this.reloadTrigger
            this.loading = false
        },
        async executeOLAPCrossNavigation(crossNavigationParams: any) {
            let temp = {} as any
            this.loading = true
            await this.$http.get(import.meta.env.VITE_KNOWAGE_CONTEXT + `/restful-services/1.0/crossNavigation/${this.document.label}/loadCrossNavigationByDocument`).then((response: AxiosResponse<any>) => (temp = response.data))
            this.loading = false

            if (!temp || temp.length === 0) {
                this.setError({
                    title: this.$t('common.error.generic'),
                    msg: this.$t('documentExecution.main.crossNavigationNoTargetError')
                })
                return
            }
            this.document = {
                ...temp[0].document,
                navigationParams: this.formatOLAPNavigationParams(crossNavigationParams, temp[0].navigationParams)
            }
            const index = this.breadcrumbs.findIndex((el: any) => el.label === this.document.name)
            index !== -1
                ? (this.breadcrumbs[index].document = this.document)
                : this.breadcrumbs.push({
                      label: this.document.name,
                      document: this.document
                  })
            await this.loadPage()
            this.reloadTrigger = !this.reloadTrigger
        },
        formatOLAPNavigationParams(crossNavigationParams: any, navigationParams: any) {
            const crossNavigationParamKeys = Object.keys(crossNavigationParams)
            const formattedParams = {} as any
            Object.keys(navigationParams).forEach((key: string) => {
                const index = crossNavigationParamKeys.findIndex((el: string) => el === navigationParams[key].value.label)
                if (index !== -1) formattedParams[key] = crossNavigationParams[crossNavigationParamKeys[index]]
            })
            return formattedParams
        },
        isOlapDesignerMode() {
            if (this.$route.name === 'olap-designer') this.olapDesignerMode = true
        },
        isOrganizerEnabled() {
            return this.user.isSuperadmin || this.user.functionalities.includes(UserFunctionalitiesConstants.DOCUMENT_ADMIN_MANAGEMENT) || this.user.functionalities.includes(UserFunctionalitiesConstants.SAVE_INTO_FOLDER_FUNCTIONALITY)
        },
        addToWorkspace() {
            this.workspaceFolderPickerDialogVisible = true
        },
        async loadUserConfig() {
            this.sessionEnabled = this.configurations['SPAGOBI.SESSION_PARAMETERS_MANAGER.enabled'] === 'false' ? false : true
            this.dateFormat = this.configurations['SPAGOBI.DATE-FORMAT-SERVER.format'] === '%Y-%m-%d' ? 'dd/MM/yyyy' : this.configurations['SPAGOBI.DATE-FORMAT-SERVER.format']
        },
        saveParametersInSession() {
            const tempFilters = deepcopy(this.filtersData)
            tempFilters.filterStatus?.forEach((filter: any) => ['dataDependsOnParameters', 'dataDependentParameters', 'dependsOnParameters', 'dependentParameters', 'lovDependsOnParameters', 'lovDependentParameters'].forEach((field: string) => delete filter[field]))
            sessionStorage.setItem(this.document.label, JSON.stringify(tempFilters))
        },
        async onCrossNavigationSelected(event: any) {
            this.destinationSelectDialogVisible = false
            this.angularData ? await loadCrossNavigation(this, event, this.angularData) : this.getDocumentAfterCrossNavigationIsSelected(event)
        },
        onCrossNavigationContainerClose() {
            this.crossNavigationContainerData = null
            this.crossNavigationContainerVisible = false
            this.crossNavigationSourceDocumentName = ''
            this.onBreadcrumbClick(this.breadcrumbs[this.breadcrumbs.length - 1])
        },
        addWidget() {
            emitter.emit('openNewWidgetPicker', this.document.dashboardId)
        },
        openDashboardDatasetManagement() {
            this.managementOpened = true
            emitter.emit('openDatasetManagement', this.document.dashboardId)
        },
        setEventListeners() {
            emitter.on('datasetManagementOpened', this.onWidgetEditorOpened)
            emitter.on('datasetManagementClosed', this.onDatasetManagementClosed)
            emitter.on('widgetEditorOpened', this.onWidgetEditorOpened)
            emitter.on('widgetEditorClosed', this.onWidgetEditorClosed)
            emitter.on('dashboardGeneralSettingsClosed', this.onDashboardGeneralSettingsClosed)
        },
        removeEventListeners() {
            emitter.off('datasetManagementOpened', this.onWidgetEditorOpened)
            emitter.off('datasetManagementClosed', this.onDatasetManagementClosed)
            emitter.off('widgetEditorOpened', this.onWidgetEditorOpened)
            emitter.off('widgetEditorClosed', this.onWidgetEditorClosed)
            emitter.off('dashboardGeneralSettingsClosed', this.onDashboardGeneralSettingsClosed)
        },
        onDatasetManagementClosed() {
            this.managementOpened = false
        },
        onWidgetEditorOpened() {
            this.managementOpened = true
        },
        onWidgetEditorClosed() {
            this.managementOpened = false
        },
        onDashboardGeneralSettingsClosed() {
            this.dashboardGeneralSettingsOpened = false
        },
        openDashboardGeneralSettings(mode: string) {
            this.dashboardGeneralSettingsOpened = true
            emitter.emit('openDashboardGeneralSettings', { dashboardId: this.document.dashboardId, mode: mode })
        },
        saveDashboard() {
            emitter.emit('saveDashboard', this.document.dashboardId)
        },
        async onNewDashboardSaved(document: { name: string; label: string }) {
            if (this.breadcrumbs[0]) this.breadcrumbs[0].label = document.name
            this.document.label = document.label
            this.newDashboardMode = false
            await this.loadDocument()
            this.userRole = this.user.sessionRole !== this.$t('role.defaultRolePlaceholder') ? this.user.sessionRole : null
            this.userRole ? await this.loadPage(true) : (this.parameterSidebarVisible = true)
        },
        async onExecuteCrossNavigation(payload: { documentCrossNavigationOutputParameters: ICrossNavigationParameter[]; crossNavigationName: string | undefined; crossNavigations: IDashboardCrossNavigation[] }) {
            this.crossNavigationPayload = payload
            if (!payload.crossNavigations || payload.crossNavigations.length === 0) {
                this.setError({
                    title: this.$t('common.error.generic'),
                    msg: this.$t('documentExecution.main.crossNavigationError')
                })
                return
            }
            const selectedCrossNavigation = getSelectedCrossNavigation(payload.crossNavigationName, payload.crossNavigations)
            if (!selectedCrossNavigation) {
                this.crossNavigationDocuments = payload.crossNavigations
                this.destinationSelectDialogVisible = true
                return
            }

            this.executeCrossNavigation(selectedCrossNavigation, payload.documentCrossNavigationOutputParameters)
        },
        async getDocumentAfterCrossNavigationIsSelected(crossNavigation: IDashboardCrossNavigation) {
            const documentCrossNavigationParameters = this.crossNavigationPayload ? this.crossNavigationPayload.documentCrossNavigationOutputParameters : []
            this.executeCrossNavigation(crossNavigation, documentCrossNavigationParameters)
        },
        async executeCrossNavigation(crossNavigation: IDashboardCrossNavigation, documentCrossNavigationParameters: ICrossNavigationParameter[]) {
            if (crossNavigation.crossType === 2) {
                const tempDocument = getDocumentForCrossNavigation(documentCrossNavigationParameters, this.filtersData, crossNavigation)
                this.openCrossNavigationInNewWindow(tempDocument, crossNavigation)
            } else if (crossNavigation.crossType === 1) {
                this.crossNavigationPopupDialogDocument = getDocumentForCrossNavigation(documentCrossNavigationParameters, this.filtersData, crossNavigation)
                this.crossNavigationDialogVisible = true
            } else {
                this.document = getDocumentForCrossNavigation(documentCrossNavigationParameters, this.filtersData, crossNavigation)
                updateBreadcrumbForCrossNavigation(this.breadcrumbs, this.document)
                await this.loadPage(false, this.document.dsLabel, false)
            }
        },
        openCrossNavigationInNewWindow(tempDocument: any, crossNavigation: IDashboardCrossNavigation) {
            const parameters = encodeURI(JSON.stringify(tempDocument.formattedCrossNavigationParameters))
            const url = `${import.meta.env.VITE_HOST_URL}${import.meta.env.VITE_KNOWAGE_VUE_CONTEXT}/document-browser/dashboard/${this.document.label}?role=${this.userRole}&crossNavigationParameters=${parameters}`
            const popupOptions = crossNavigation.popupOptions ?? {
                width: '800',
                height: '600'
            }
            window.open(url, '_blank', `toolbar=0,status=0,menubar=0,width=${popupOptions.width},height=${popupOptions.height}`)
        },
        onCrossNavigationPopupClose() {
            this.crossNavigationPopupDialogDocument = null
            this.crossNavigationDialogVisible = false
            this.onBreadcrumbClick(this.breadcrumbs[this.breadcrumbs.length - 1])
        },
        onSetDashboardId(event: any, breadcrumb: ICrossNavigationBreadcrumb) {
            breadcrumb.document.dashboardId = event
            this.document.dashboardId = event
        },
        async executeView(view: IDashboardView) {
            this.savedViewsListDialogVisible = false
            if (view.biObjectTypeCode === 'DASHBOARD') this.dashboardView = view
            else this.cockpitViewForExecution = view
            await this.loadPage()
        },
        openSaveCurrentViewDialog() {
            this.currentCockpitView.drivers = this.filtersData
            this.selectedCockpitView = { ...this.currentCockpitView, new: true }
            this.saveViewDialogVisible = true
        },
        openSavedViewsListDialog() {
            this.savedViewsListDialogVisible = true
        },
        onSaveViewDialogClose() {
            this.saveViewDialogVisible = false
            this.selectedCockpitView = null
        },
        moveView(view: IDashboardView) {
            this.savedViewsListDialogVisible = false
            this.selectedCockpitView = view
            this.saveViewDialogVisible = true
        },
        fullScreen() {
            const widgetElement = this.$refs['document'] as any
            widgetElement.requestFullscreen()
        },
        toggleFinalUser() {
            if (this.seeAsFinalUser) {
                delete this.document.seeAsFinalUser
                seeAsFinalUserWarning()
            } else {
                this.document.seeAsFinalUser = true
                seeAsFinalUserWarning = this.$q.notify({
                    message: this.$t('documentExecution.main.seeAsFinalUserWarning'),
                    type: 'warning',
                    timeout: 0,
                    position: 'top'
                })
            }
            this.seeAsFinalUser = !this.seeAsFinalUser
        }
    }
})
</script>

<style lang="scss">
.hidden-button {
    display: none;
}
.document-execution-view {
    background: white;
    position: relative;
    height: 100%;
    width: 100%;
}

.document-execution-backdrop {
    background-color: rgba(33, 33, 33, 1);
    opacity: 0.48;
    z-index: 50;
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
}

.document-execution-backdrop-popup-dialog {
    background-color: rgba(33, 33, 33, 1);
    opacity: 0.48;
    z-index: 50;
    position: absolute;
    width: 100%;
    height: calc(80vh - 35px);
    top: 0;
    left: 0;
}

.document-execution-parameter-sidebar {
    margin-left: auto;
}

.document-execution-iframe {
    width: 100%;
    height: 100%;
}

#document-execution-schedulations-table {
    position: relative;
    z-index: 100;
    width: 100%;
    height: 90%;
}

.document-execution-iframe {
    border: 0;
}

.detail-page-container {
    display: flex;
    flex-direction: column;
}
@media print {
    body * {
        visibility: hidden;
    }
    .document-execution-view,
    .document-execution-view * {
        visibility: visible;
    }

    .document-execution-view .document-execution-parameter-sidebar,
    .document-execution-view .document-execution-parameter-sidebar *,
    .document-execution-view .document-execution-backdrop {
        visibility: hidden;
    }

    .document-execution-view {
        background-color: white;
        height: 100%;
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        margin: 0;
    }
}

.p-tieredmenu .p-menuitem-active > .p-submenu-list {
    left: unset !important;
}

.p-submenu-list {
    right: 100% !important;
}

.dashboard-toolbar-icon {
    border: 1px solid white !important;
    padding: 1.5px !important;
    border-radius: 5px !important;
}

#add-widget-button {
    background-color: var(--kn-color-fab);
    min-width: 120px;
}
.downloadingBox {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: 1px solid var(--kn-message-warning-color);
    background-color: var(--kn-message-warning-background-color);
    color: 1px solid var(--kn-message-warning-color);
    font-weight: bold;
    padding: 16px 32px;
}
</style>
